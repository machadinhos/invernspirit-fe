#!/bin/bash
set -eo pipefail

commit_msg=$(cat "$1")

if echo "$commit_msg" | grep -q "^Merge "; then
  exit 0
fi

if echo "$commit_msg" | grep -q "^Revert "; then
  exit 0
fi

pattern="^(chore|ci|docs|feat|fix|perf|refactor|style|test)(\([a-zA-Z0-9_-]+\))?: .*"

commit_msg_no_comments=$(echo "$commit_msg" | grep -v '^#')

if ! echo "$commit_msg_no_comments" | grep -Eq "$pattern"; then
  echo "Invalid commit message format."
  echo ""
  echo "Your commit message:"
  echo "$commit_msg_no_comments"
  echo ""
  echo "Expected format:"
  echo "  type(scope): description"
  echo ""
  echo "Valid types:"
  echo "  • feat:     A new feature"
  echo "  • fix:      A bug fix"
  echo "  • docs:     Documentation only changes"
  echo "  • style:    Changes that do not affect the meaning of the code"
  echo "  • refactor: A code change that neither fixes a bug nor adds a feature"
  echo "  • perf:     A code change that improves performance"
  echo "  • test:     Adding missing tests or correcting existing tests"
  echo "  • ci:       Changes to CI configuration files and scripts"
  echo "  • chore:    Other changes that don't modify src or test files"
  echo ""
  echo "Examples:"
  echo "  feat: add user authentication"
  echo "  fix(api): handle null response from server"
  echo "  refactor: extract utility functions"
  echo ""
  echo "Rules:"
  echo "  • Type is required and must be lowercase"
  echo "  • Scope is optional but must be in parentheses"
  echo "  • Description must start with lowercase letter"
  echo "  • Use present tense (add, not added)"
  echo "  • Keep first line under 50 characters when possible"
  echo ""
  echo "Learn more at Learn more: https://www.conventionalcommits.org/"
  exit 1
fi

first_line=$(echo "$commit_msg_no_comments" | head -n1)

if [ ${#first_line} -gt 50 ]; then
  echo "Commit message first line is ${#first_line} characters long."
  echo "Consider keeping it under 50 characters for better readability."
  echo ""
fi

description=$(echo "$first_line" | sed -E 's/^[a-z]+(\([^)]+\))?: //')
if echo "$description" | grep -q "^[A-Z]"; then
  echo "Description should start with a lowercase letter."
  echo "Current: $description"
  echo "Should be: $(echo "$description" | sed 's/^./\L&/')"
  exit 1
fi

if echo "$first_line" | grep -q "\.$"; then
  echo "Don't end the commit message with a period."
  echo "Current: $first_line"
  exit 1
fi
